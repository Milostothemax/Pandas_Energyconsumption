import pandas as pd
import openpyxl
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.dates as dates

# Reading files
sheet1 = pd.read_excel(r'MYDATA.xlsx')
sheet2 = pd.read_csv(r'MYDATA.csv', sep=',',nrows=16656,encoding = 'utf_8_sig')
sheet3 = pd.read_excel(r'MYDATA.xlsx')

#Energy variables
gross_annual_demand = 3100
three_kwp_battery_kwh = 3000
six_kwp_battery_kwh = 6000

#Makes sheets into data frames
df1 = pd.DataFrame(sheet1)
df2 = pd.DataFrame(sheet2)
df3 = pd.DataFrame(sheet3)

#Processes sheet 2 into the same format as other sheets (price in pence per kwh)
df2np = df2.iloc[:, 4].to_numpy().reshape(-1, 48)

#df1 - Energy consumption in kWhr
df1_kwh = df1.iloc[18:365, 1:49].multiply(gross_annual_demand)

#df2 - 3kwp system - Solar Generation in kWhr
df3_three_kwh = df3.iloc[18:365, 1:49].multiply(three_kwp_battery_kwh)
#print(df3_three_kwh)

#df2 - - 6kwp system - Solar Generation in kWhr
df3_six_kwh = df3.iloc[18:365, 1:49].multiply(six_kwp_battery_kwh)
#print(df3_six_kwh)

 #multiplies df2 kwh by agile tarrif then sums the value in pence for each day
df_bc = df1_kwh.multiply(df2np).sum(axis=1).to_frame("Sum")
#Reinserts the dates column from df3 into the table (both df1 and 3 are the same structure)
df_bc.insert(0, 'Date', df3.iloc[:,0])
print (df_bc)

# subtracts energy generated by a 3kwp system from energy consumption in kWhr, multiplies by tarif then sums the value in pence for each day
df_3kw = df1_kwh.subtract(df3_three_kwh).multiply(df2np).sum(axis=1).to_frame("Sum")
# Reinserts the dates column from df3 into the table (both df1 and 3 are the same structure)
df_3kw.insert(0, 'Date', df3.iloc[:, 0])
print(df_3kw)

# subtracts energy generated by a 6kwp system from energy consumption in kWhr, multiplies by tarif then sums the value in pence for each day
df_6kw = df1_kwh.subtract(df3_six_kwh).multiply(df2np).sum(axis=1).to_frame("Sum")
# Reinserts the dates column from df3 into the table (both df1 and 3 are the same structure)
df_6kw.insert(0, 'Date', df3.iloc[:, 0])
print(df_6kw)

#Generates line graph shwoing all 3 models
def graph():
    fig = plt.figure()

    for frame in [df_6kw, df_3kw, df_bc]:
        plt.plot(frame['Date'], frame['Sum'])
    plt.legend(['6kWp', '3kWp', 'Base Consumption'], loc='best', title='')
    plt.ylabel('Energy Consumption (Pence)')
    plt.xlabel('Date')
    plt.show()

graph()
